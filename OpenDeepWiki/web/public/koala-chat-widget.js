(()=>{function m(r){if(r.apiUrl)return r.apiUrl;let t=document.querySelector('script[src*="koala-chat-widget.js"]');if(t){let e=t.getAttribute("src");if(e)try{return new URL(e,window.location.href).origin}catch{console.warn("Unable to parse script source URL:",e)}}return window.location.origin}function p(r){return r&&clearTimeout(r),null}var u=class{constructor(t){this.config=t}async validateDomain(){if(!this.config.appId)return{isValid:!1,reason:"AppId is required"};try{let t=m(this.config),e=window.location.hostname,o=await fetch(`${t}/api/AppConfig/validatedomain`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({appId:this.config.appId,domain:e})});if(!o.ok)return console.error("Domain validation request failed:",o.status),{isValid:!1,reason:"ValidationRequestFailed"};let{data:i}=await o.json();return{isValid:i.isValid,reason:i.reason,appConfig:i.appConfig}}catch(t){return console.error("Domain validation error:",t),{isValid:!1,reason:"NetworkError"}}}async validateAndUpdateConfig(){let t=await this.validateDomain();return t.isValid?(t.appConfig&&(this.config.organizationName=t.appConfig.organizationName,this.config.repositoryName=t.appConfig.repositoryName,this.config.title=t.appConfig.name||this.config.title),!0):(console.error("KoalaChatWidget: Domain validation failed -",t.reason),typeof this.config.onValidationFailed=="function"&&this.config.onValidationFailed(window.location.hostname),!1)}};var v=class{constructor(t){this.config=t}createFloatingButton(t){let e=document.createElement("button");if(e.className="koala-floating-button",e.title=`\u6253\u5F00 ${this.config.title||"AI \u52A9\u624B"}`,this.config.expandIcon)e.style.backgroundImage=`url(data:image/png;base64,${this.config.expandIcon})`,e.style.backgroundSize="cover",e.style.backgroundPosition="center";else{let o=m(this.config);e.innerHTML=`<img src="${o}/logo.png" alt="${this.config.title||"AI \u52A9\u624B"}" style="width: 64px; height: 64px;">`}return this.addDragFunctionality(e),e.addEventListener("click",t),e}addDragFunctionality(t){let e=!1,o=0,i=0,n=0,s=0,l=!1,C=a=>{e=!0,l=!1,o=a.clientX,i=a.clientY;let c=t.getBoundingClientRect();n=c.left,s=c.top,t.style.transition="none",t.classList.add("dragging"),document.addEventListener("mousemove",g),document.addEventListener("mouseup",k),a.preventDefault()},g=a=>{if(!e)return;let c=a.clientX-o,h=a.clientY-i;(Math.abs(c)>5||Math.abs(h)>5)&&(l=!0);let f=n+c,T=s+h,w=window.innerWidth-t.offsetWidth,E=window.innerHeight-t.offsetHeight,b=Math.max(0,Math.min(f,w)),M=Math.max(0,Math.min(T,E));t.style.left=`${b}px`,t.style.top=`${M}px`,t.style.right="auto",t.style.bottom="auto"},k=()=>{e=!1,t.style.transition="transform 0.2s ease",t.classList.remove("dragging"),document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",k),l&&setTimeout(()=>{l=!1},100)},I=a=>{if(a.touches.length!==1)return;let c=a.touches[0];e=!0,l=!1,o=c.clientX,i=c.clientY;let h=t.getBoundingClientRect();n=h.left,s=h.top,t.style.transition="none",t.classList.add("dragging"),document.addEventListener("touchmove",L,{passive:!1}),document.addEventListener("touchend",H),a.preventDefault()},L=a=>{if(!e||a.touches.length!==1)return;let c=a.touches[0],h=c.clientX-o,f=c.clientY-i;(Math.abs(h)>5||Math.abs(f)>5)&&(l=!0);let T=n+h,w=s+f,E=window.innerWidth-t.offsetWidth,b=window.innerHeight-t.offsetHeight,M=Math.max(0,Math.min(T,E)),S=Math.max(0,Math.min(w,b));t.style.left=`${M}px`,t.style.top=`${S}px`,t.style.right="auto",t.style.bottom="auto",a.preventDefault()},H=()=>{e=!1,t.style.transition="transform 0.2s ease",t.classList.remove("dragging"),document.removeEventListener("touchmove",L),document.removeEventListener("touchend",H),l&&setTimeout(()=>{l=!1},100)},z=t.onclick;t.onclick=a=>{if(l)return a.preventDefault(),a.stopPropagation(),!1;if(z)return z.call(t,a)},t.addEventListener("mousedown",C),t.addEventListener("touchstart",I,{passive:!1})}createChatContainer(t,e,o){let i=document.createElement("div");i.className="koala-chat-container";let n=this.createHeader(t,e,o),s=document.createElement("div");return s.className="koala-chat-content",this.showLoading(s),i.appendChild(n),i.appendChild(s),i}createHeader(t,e,o){let i=document.createElement("div");i.className="koala-chat-header";let n=document.createElement("div");n.className="koala-header-title",n.innerHTML=`${this.config.title||"AI \u52A9\u624B"}`;let s=document.createElement("div");s.className="koala-header-actions";let l=this.createHeaderButton("\u2212","\u6700\u5C0F\u5316",t),C=this.createHeaderButton("\u26F6","\u6700\u5927\u5316",e),g=this.createCloseButton(o);return s.appendChild(l),s.appendChild(C),s.appendChild(g),i.appendChild(n),i.appendChild(s),i}createHeaderButton(t,e,o){let i=document.createElement("button");return i.className="koala-header-btn",i.innerHTML=t,i.title=e,i.addEventListener("click",o),i}createCloseButton(t){let e=document.createElement("button");if(e.className="koala-header-btn",e.title="\u5173\u95ED",this.config.closeIcon){let o=document.createElement("img");o.src=`data:image/png;base64,${this.config.closeIcon}`,o.alt="\u5173\u95ED",o.style.width="14px",o.style.height="14px",e.appendChild(o)}else e.innerHTML="\xD7";return e.addEventListener("click",t),e}showLoading(t){t.innerHTML=`
      <div class="koala-loading">
        <div>\u6B63\u5728\u52A0\u8F7D AI \u52A9\u624B...</div>
      </div>
    `}showError(t,e){t.innerHTML=`
      <div class="koala-error">
        <div class="koala-error-title">\u52A0\u8F7D\u5931\u8D25</div>
        <div class="koala-error-description">${e}</div>
      </div>
    `}loadChatInterface(t){if(!this.config.organizationName||!this.config.repositoryName){this.showError(t,"\u5E94\u7528\u914D\u7F6E\u7F3A\u5931\uFF0C\u65E0\u6CD5\u52A0\u8F7D\u804A\u5929\u754C\u9762");return}let e=m(this.config),o=new URLSearchParams({appId:this.config.appId,organizationName:this.config.organizationName,repositoryName:this.config.repositoryName,title:this.config.title||"AI \u52A9\u624B",theme:this.config.theme||"light",embedded:"true"});this.config.expandIcon&&o.set("expandIcon",this.config.expandIcon),this.config.closeIcon&&o.set("closeIcon",this.config.closeIcon);let i=`${e}/chat/embedded?${o.toString()}`,n=document.createElement("iframe");n.src=i,n.className="koala-iframe-container",n.frameBorder="0",n.setAttribute("allowtransparency","true"),t.innerHTML="",t.appendChild(n)}};var x=class{constructor(t){this.tooltipElement=null;this.tooltipTimer=null;this.tooltipHideTimer=null;this.lastTooltipHideTime=0;this.lastActivity=Date.now();this.floatingButton=null;this.isExpanded=!1;this.onToggleChat=null;this.config=t}setFloatingButton(t){this.floatingButton=t}setExpanded(t){this.isExpanded=t}initActivityListeners(t){let e=["mousedown","mousemove","keypress","scroll","touchstart","click"],o=()=>{let i=Date.now();i-this.lastActivity<1e3||(this.lastActivity=i,this.hideTooltip(),this.config.enableTooltip&&this.floatingButton&&!this.isExpanded&&this.startTooltipTimer())};e.forEach(i=>{document.addEventListener(i,o,{passive:!0,capture:!0})}),this.onToggleChat=t}startTooltipTimer(){this.tooltipTimer=p(this.tooltipTimer),this.tooltipHideTimer=p(this.tooltipHideTimer);let t=Date.now(),e=this.config.tooltipDelay||5e3;if(this.lastTooltipHideTime>0){let o=t-this.lastTooltipHideTime,i=this.config.tooltipRepeatDelay||3e4;o<i&&(e=i-o)}this.tooltipTimer=setTimeout(()=>{!this.isExpanded&&this.floatingButton&&this.showTooltip()},e)}showTooltip(){if(!(!this.config.enableTooltip||!this.config.tooltipText||this.isExpanded)&&(this.tooltipElement||this.createTooltip(),this.tooltipElement)){this.tooltipElement.textContent=this.config.tooltipText,this.tooltipElement.classList.add("visible");let t=this.config.tooltipDuration||3e3;t>0&&(this.tooltipHideTimer=setTimeout(()=>{this.hideTooltip()},t))}}hideTooltip(){this.tooltipElement&&this.tooltipElement.classList.remove("visible"),this.tooltipHideTimer=p(this.tooltipHideTimer),this.lastTooltipHideTime=Date.now()}createTooltip(){this.tooltipElement=document.createElement("div"),this.tooltipElement.className="koala-tooltip",document.body.appendChild(this.tooltipElement);let t=()=>{if(this.floatingButton&&this.tooltipElement){let e=this.floatingButton.getBoundingClientRect(),o=this.tooltipElement.getBoundingClientRect(),i=window.innerHeight-e.top+12,n=window.innerWidth-e.left-e.width/2-o.width/2;this.tooltipElement.style.bottom=i+"px",this.tooltipElement.style.right=Math.max(12,n)+"px"}};this.tooltipElement.addEventListener("click",e=>{e.stopPropagation(),this.onToggleChat&&this.onToggleChat()}),window.addEventListener("resize",t),requestAnimationFrame(t)}destroy(){this.tooltipTimer=p(this.tooltipTimer),this.tooltipHideTimer=p(this.tooltipHideTimer),this.tooltipElement&&(this.tooltipElement.remove(),this.tooltipElement=null),this.lastActivity=Date.now(),this.lastTooltipHideTime=0}};function B(){let r=".koala-chat-widget{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;direction:ltr}.koala-floating-button{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:#1677ff;border:none;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:10000;cursor:pointer;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;transition:transform 0.2s ease;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;touch-action:none}.koala-floating-button:hover{transform:scale(1.05)}.koala-floating-button:active{transform:scale(0.95)}.koala-floating-button.dragging{cursor:grabbing;cursor:-webkit-grabbing;transform:scale(1.1);box-shadow:0 8px 32px rgba(0,0,0,0.25)}.koala-chat-container{position:fixed;bottom:24px;right:24px;width:550px;height:700px;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.12);z-index:10001;display:none;flex-direction:column;overflow:hidden;border:1px solid #d9d9d9}.koala-chat-container.visible{display:flex}.koala-chat-container.minimized{height:56px}.koala-chat-container.maximized{width:550px;height:100vh;bottom:0;right:0;top:0}.koala-chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #d9d9d9;background:white;min-height:56px}.koala-header-title{display:flex;align-items:center;gap:8px;flex:1;font-size:16px;font-weight:600;margin:0;color:#262626}.koala-header-actions{display:flex;gap:4px}.koala-header-btn{width:24px;height:24px;border:none;background:none;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#8c8c8c;transition:background-color 0.2s}.koala-header-btn:hover{background-color:#f5f5f5;color:#595959}.koala-chat-content{flex:1;display:flex;flex-direction:column;overflow:hidden}.koala-loading{display:flex;align-items:center;justify-content:center;padding:20px;color:#8c8c8c}.koala-error{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;color:#ff4d4f;text-align:center}.koala-error-title{font-weight:500;margin-bottom:8px}.koala-error-description{font-size:14px;color:#8c8c8c}.koala-iframe-container{flex:1;border:none;width:100%;height:100%}.koala-tooltip{position:fixed;background:rgba(0,0,0,0.8);color:white;padding:8px 12px;border-radius:8px;font-size:14px;white-space:nowrap;z-index:998;opacity:0;transform:translateY(10px);transition:opacity 0.3s ease,transform 0.3s ease;pointer-events:none}.koala-tooltip.visible{opacity:1;transform:translateY(0)}.koala-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(0,0,0,0.8)}@media (max-width:768px){.koala-chat-container{bottom:0;right:0;left:0;width:100%;height:100%;border-radius:0}.koala-chat-container.maximized{width:100%;height:100%}.koala-floating-button{bottom:20px;right:20px}.koala-tooltip{bottom:84px;right:20px;max-width:calc(100vw - 40px);white-space:pre-wrap}}",t=document.createElement("style");t.textContent=r,document.head.appendChild(t)}var y=class{constructor(){this.version="1.0.0";this.config={appId:"",organizationName:"default",repositoryName:"default",title:"AI \u52A9\u624B",expandIcon:"",closeIcon:"",apiUrl:"",theme:"light",enableTooltip:!0,tooltipText:"\u70B9\u51FB\u6211\u8BE2\u95EE\u60A8\u60F3\u77E5\u9053\u7684\uFF01",tooltipDelay:5e3,tooltipDuration:3e3,tooltipRepeatDelay:3e4};this.floatingButton=null;this.chatContainer=null;this.isExpanded=!1;this.isMinimized=!1;this.isMaximized=!1;this.isValidated=!1}async init(t){try{if(this.config={...this.config,...t},!this.config.appId){console.error("KoalaChatWidget: appId is required");return}if(this.validationService=new u(this.config),this.uiComponents=new v(this.config),this.tooltipManager=new x(this.config),!await this.validationService.validateAndUpdateConfig())return;this.isValidated=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>this.initWidget(),100)}):setTimeout(()=>this.initWidget(),100)}catch(e){console.error("KoalaChatWidget initialization failed:",e),typeof this.config.onError=="function"&&this.config.onError(e instanceof Error?e.message:String(e))}}initWidget(){try{B(),this.floatingButton=this.uiComponents.createFloatingButton(()=>this.toggle()),document.body.appendChild(this.floatingButton),this.tooltipManager.setFloatingButton(this.floatingButton),this.tooltipManager.initActivityListeners(()=>this.toggle()),this.config.enableTooltip&&this.tooltipManager.startTooltipTimer(),console.log("KoalaChatWidget initialized successfully")}catch(t){console.error("KoalaChatWidget initialization failed:",t),typeof this.config.onError=="function"&&this.config.onError(t instanceof Error?t.message:String(t))}}async open(){if(!this.isValidated){if(!await this.validationService.validateAndUpdateConfig())return;this.isValidated=!0}if(this.tooltipManager.hideTooltip(),!this.chatContainer){this.chatContainer=this.uiComponents.createChatContainer(()=>this.minimizeChat(),()=>this.toggleMaximize(),()=>this.close()),document.body.appendChild(this.chatContainer);let t=this.chatContainer.querySelector(".koala-chat-content");t&&this.uiComponents.loadChatInterface(t)}this.chatContainer.classList.add("visible"),this.floatingButton&&(this.floatingButton.style.display="none"),this.isExpanded=!0,this.isMinimized=!1,this.tooltipManager.setExpanded(!0)}close(){this.chatContainer&&(this.chatContainer.classList.remove("visible"),this.chatContainer.classList.remove("minimized"),this.chatContainer.classList.remove("maximized")),this.floatingButton&&(this.floatingButton.style.display="flex"),this.isExpanded=!1,this.isMinimized=!1,this.isMaximized=!1,this.tooltipManager.setExpanded(!1),this.config.enableTooltip&&this.tooltipManager.startTooltipTimer()}async toggle(){this.isExpanded?this.close():await this.open()}minimizeChat(){this.chatContainer&&(this.chatContainer.classList.add("minimized"),this.isMinimized=!0)}toggleMaximize(){this.chatContainer&&(this.isMaximized?(this.chatContainer.classList.remove("maximized"),this.isMaximized=!1):(this.chatContainer.classList.add("maximized"),this.isMaximized=!0))}destroy(){this.floatingButton&&(this.floatingButton.remove(),this.floatingButton=null),this.chatContainer&&(this.chatContainer.remove(),this.chatContainer=null),this.tooltipManager?.destroy(),this.isExpanded=!1,this.isMinimized=!1,this.isMaximized=!1,this.isValidated=!1}};var d=new y;window.KoalaChatWidget={init:d.init.bind(d),destroy:d.destroy.bind(d),open:d.open.bind(d),close:d.close.bind(d),toggle:d.toggle.bind(d),version:d.version};})();
//# sourceMappingURL=koala-chat-widget.js.map
